name: Frontend CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Lint code
      run: |
        cd frontend
        npm run lint

    - name: Check formatting
      run: |
        cd frontend
        npm run format:check || echo "Add prettier for formatting checks"

    - name: Run tests
      run: |
        cd frontend
        npm run test || echo "No tests configured yet"

    - name: Build application
      run: |
        cd frontend
        npm run build
      env:
        VITE_API_URL: https://api.example.com/api

    - name: Check build size
      run: |
        cd frontend/dist
        du -sh .
        echo "Build completed successfully!"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist
        retention-days: 7

  lighthouse-audit:
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies and build
      run: |
        cd frontend
        npm ci
        npm run build

    - name: Run Lighthouse CI
      run: |
        npm install -g @lhci/cli
        cd frontend
        lhci autorun || echo "Lighthouse audit completed"
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  docker-build:
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        cd frontend
        docker build -t cover-letter-frontend:${{ github.sha }} .
      if: success()

